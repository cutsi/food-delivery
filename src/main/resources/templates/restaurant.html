<!DOCTYPE html>
<html lang="en" class="h-100" xmlns:th="https://thymeleaf.org" xmlns="http://www.w3.org/1999/html"
      xmlns:sec="http://www.w3.org/1999/xhtml">

<head th:replace="fragments/general :: head"></head>
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script>document.getElementsByTagName("html")[0].className += " js";</script>
    <link href="../static/css/experiment.css" th:href="@{/css/experiment.css}" rel="stylesheet" />
    <link href="../static/css/carousel.css" th:href="@{/css/carousel.css}" rel="stylesheet" />
    <link href="../static/css/test.css" th:href="@{/css/test.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="../static/css/popup.css" th:href="@{/css/popup.css}" rel="stylesheet" />
    <link href="../static/css/rating.css" th:href="@{/css/rating.css}" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">


    <style>
        .img-sm {
            width: 46px;
            height: 46px;
        }

        .panel {
            box-shadow: 0 2px 0 rgba(0,0,0,0.075);
            border-radius: 0;
            border: 0;
            margin-bottom: 15px;
        }

        .panel .panel-footer, .panel>:last-child {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .panel .panel-heading, .panel>:first-child {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        .panel-body {
            padding: 5px 10px;
        }


        .media-block .media-left {
            display: block;
            float: left
        }

        .media-block .media-right {
            float: right
        }

        .media-block .media-body {
            display: block;
            overflow: hidden;
            width: auto;
            MARGIN-BOTTOM: 1REM;
            border-bottom: 2px solid lightgray;
        }

        .middle .media-left,
        .middle .media-right,
        .middle .media-body {
            vertical-align: middle
        }

        .thumbnail {
            border-radius: 0;
            border-color: #e9e9e9
        }

        .tag.tag-sm, .btn-group-sm>.tag {
            padding: 5px 10px;
        }

        .tag:not(.label) {
            background-color: #fff;
            padding: 6px 12px;
            border-radius: 2px;
            border: 1px solid #cdd6e1;
            font-size: 12px;
            line-height: 1.42857;
            vertical-align: middle;
            -webkit-transition: all .15s;
            transition: all .15s;
        }
        .text-muted, a.text-muted:hover, a.text-muted:focus {
            color: #acacac;
        }
        .text-sm {
            font-size: 0.9em;
        }
        .text-5x, .text-4x, .text-5x, .text-2x, .text-lg, .text-sm, .text-xs {
            line-height: 1.25;
        }

        .btn-trans {
            background-color: transparent;
            border-color: transparent;
            color: #929292;
        }

        .btn-icon {
            padding-left: 9px;
            padding-right: 9px;
        }

        .btn-sm, .btn-group-sm>.btn, .btn-icon.btn-sm {
            padding: 5px 10px !important;
        }

        .mar-top {
            margin-top: 15px;
        }
    </style>

    <style>
        .grid-container {
            display: grid;
            grid-gap: 10px;
            background-color: #2196F3;
            padding: 10px;
        }

        .grid-item {
            background-color: rgba(255, 255, 255, 0.8);
            text-align: center;
            padding: 20px;
            font-size: 30px;
        }

        .item1 {
            grid-column: 1 / span 2;
            grid-row: 1;
        }

        .item2 {
            grid-column: 3;
            grid-row: 1 / span 2;
        }

        .item5 {
            grid-column: 1 / span 3;
            grid-row: 3;
        }
        @keyframes changewidth {
            from {
                left: 0px;
            }

            to {
                left: -50px
            }
        }

        .slide-right {
            white-space: nowrap !important;
            text-overflow: inherit !important;
        }

        .slide-right a {
            position: relative !important;
        }

        .slide-right a:hover {
            animation-duration: 2.5s;
            animation-name: changewidth;
            animation-iteration-count: infinite;
        }
        .cd-cart__image{
            display: flex;
            align-items: center;
        }
    </style>

    <style>
        .overlay1{
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 500ms;
            opacity: 1;
            z-index: 2;
            display: none;
        }
        .shop-closed-btn{
            border-radius: 1rem;
            margin-bottom: 1rem;
            width: 75%;
            height: 2.5rem;
            background: darkred;
            color: white;
        }
    </style>
</head>

<body class="d-flex flex-column h-100">

<main role="main" class="flex-shrink-0">
    <header th:replace="fragments/general :: header"></header>


    <section id="page-header">
        <div class="jumbotron jumbotron-fluid" th:style="'background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(' + ${restaurant.getImage()} + ');'">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 col-width">
                        <h2 class="jumbotron-header">[[${restaurant.getRestaurantName()}]]
                        </h2>

                    </div>
                </div>
            </div>

            <div th:if="${isClosed == true}">
                <div style="margin-left: 1.5rem;">
                    Trenutno otvoren
                </div>
            </div>

            <div th:if="${isClosed == false}">
                <div style="margin-left: 1.5rem;">
                    Trenutno zatvoren
                </div>
            </div>
            <div style="margin-left: 1.5rem;">
                <div th:if="${workingHoursToday.getOpensAt() != 'Zatvoreno'}">
                Dostava danas: [[${workingHoursToday.getOpensAt()}]] - [[${workingHoursToday.getClosesAt()}]]
                </div>
            </div>
            <div class="popup-group">
                <a class="button" href="#popup1">Informacije</a>
                <a class="button" href="#popup2">Komentari</a>
            </div>
            <div>
                <div class="comment-rating">
                    ([[${numberOfReviews}]]) <input type="radio" id="jumbotron-star" checked>
                    <label for="jumbotron-star"></label> [[${averageRating}]]
                </div>
            </div>
        </div>


    </section>


    <section>
        <div th:if="${isClosed == false}">
            <div class="overlay1">
                <div class="popup">
                    <h2 class="popup-header">Ovaj restoran je trenutno zatvoren</h2>
                    <a class="close" id="klose" href="#">&times;</a>
                    <div class="content" style="text-align: center;">
                        <a href="#">
                            <button class="shop-closed-btn" id="shop-closed-popup" href="#"> SAMO PREGLEDAVAM</button><br>
                        </a>
                        <a href="/">
                            <button class="shop-closed-btn" href="/"> NATRAG</button>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>




    <div class="slider owl-carousel">
        <th:block th:each="category: ${categories}">
            <div class="card1">
                <div class="img1">
                    <img th:src="${category.getImage()}" src ="${category.getImage()}" alt="">
                </div>
            </div>
        </th:block>
    </div>
    <script>
        $(".slider").owlCarousel({
            loop: true,
            autoplay: true,
            autoplayTimeout: 4000, //2000ms = 2s;
            autoplayHoverPause: true,
        });
    </script>


    <section>
        <div id="popup1" class="overlay">
            <div class="popup">
                <h2 class="popup-header">Informacije</h2>
                <a class="close" href="#close">&times;</a>
                <h3 class="content-header">Adresa</h3>
                <div class="content">
                    [[${restaurant.getAddress()}]]
                </div>
                <h3 class="content-header">Cijena dostave</h3>
                <div class="content">
                    [[${restaurant.getDeliveryCost()}]]
                </div>
                <h3 class="content-header">Način plaćanja</h3>
                <div class="content">
                    Gotovina
                </div>
                <h3 class="content-header">Radno vrijeme</h3>
                <div class="content">
                    <table>
                        <th:block th:each="workingHour: ${workingHours}">
                            <tr><th class="hours">[[${workingHour.getDayOfWeek()}]]</th><td>[[${workingHour.getOpensAt()}]] [[${workingHour.getClosesAt()}]]</td></tr>
                        </th:block>
                    </table>
                </div>
            </div>
        </div>

        <div id="popup2" class="overlay">
            <div class="popup" style="height: 85%; overflow-y: auto; width: 80%">
                <h2 class="popup-header">Komentari</h2>
                <a class="close" href="#close">&times;</a>
                    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
                    <div class="container bootdey" style="padding-right: 0;padding-left: 0;">
                        <div class="col-md-12 bootstrap snippets" style="padding-right: 0;padding-left: 0;">
                            <div class="panel">
                                <div class="panel-body">
                                    <form th:action="@{/komentiraj}" method="post">
                                        <div sec:authorize='!isAuthenticated()'>
                                            <div class="komentiraj">
                                                Morate se <a href="/login"> registrirati</a> prije nego što možete komentirati.
                                            </div>
                                        </div>
                                        <div sec:authorize='isAuthenticated()'>
                                            <input type="hidden" name="restaurantName" th:value="${restaurant.getRestaurantName()}">
                                            <textarea class="form-control" rows="2" name="content" placeholder="Napišite nam vašu recenziju"></textarea>
                                            <div class="mar-top clearfix">
                                                <div class="your-rating">
                                                    Vaša ocjena:
                                                    <div class="rating">
                                                        <input type="radio" name="star" id="star5" value="5"><label for="star5"></label>
                                                        <input type="radio" name="star" id="star4" value="4"><label for="star4"></label>
                                                        <input type="radio" name="star" id="star3" value="3"><label for="star3"></label>
                                                        <input type="radio" name="star" id="star2" value="2"><label for="star2"></label>
                                                        <input type="radio" name="star" id="star1" value="1"><label for="star1"></label>
                                                    </div>
                                                </div>
                                                <button class="btn btn-sm btn-primary pull-right" type="submit">Objavi</button>
                                            </div>
                                        </div>

                                    </form>
                                </div>
                            </div>
                            <div class="panel">
                                <div class="panel-body">
                                    <!-- Newsfeed Content -->
                                    <!--===================================================-->
                                    <th:block th:each="comment: ${comments}">
                                        <div th:if="${comment.getIsApproved() == true}">
                                            <div class="media-block">
                                                <div class="media-body">
                                                    <div class="mar-btm">
                                                        <p class="" style="color: black">[[${comment.getUser().getName()}]]</p>
                                                        <p class="text-muted text-sm" style="font-size: 0.79rem;">
                                                            [[${comment.getCreatedAt().getDayOfMonth()}]].[[${comment.getCreatedAt().getMonthValue()}]].[[${comment.getCreatedAt().getYear()}]].
                                                        </p>
                                                    </div>
                                                    <p> [[${comment.getContent()}]]</p>
                                                    <div class="pad-ver" style="margin-bottom: 1.5rem;">
                                                        <div class="comment-rating">
                                                            <th:block th:each="i: ${#numbers.sequence(1, comment.getRating())}">
                                                                <input type="radio" id="${i}" checked><label for="${i}"></label>
                                                            </th:block>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </th:block>

                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </section>

    <section id="about">

        <div class="container card-container">
            <div class="menu">
                <th:block th:each="category: ${categories}">
                    <div class ="menu-group-heading">
                        [[${category.getCategoryName()}]]
                    </div>
                    <div class="menu-group">
                        <th:block th:each="foodItem: ${menu}">
                            <div th:if="${foodItem.getCategory().getId() == category.getId()}">
                                <button class="menu-item" th:id="'btnItem_'+${foodItem.getId()}">
                                    <img class="menu-item-image" th:src="${foodItem.getImage()}" src ="${foodItem.getImage()}">
                                    <div class="menu-item-text">
                                        <h3 class="menu-item-heading">
                                            <span class="menu-item-name">[[${foodItem.getName()}]]</span>
                                            <span class="menu-item-price">[[${foodItem.getPrice()}]]KM</span>
                                        </h3>
                                        <h4 class="menu-item-info">
                                            [[${foodItem.getInfo()}]]
                                        </h4>
                                    </div>
                                </button>

                                <div class="menu-item-content">

                                    <div class ="radiobutton-heading">
                                        <form th:id="${foodItem.getId()}">
                                            <div class="portion-group">
                                                <th:block th:each="portion: ${foodItem.getPortionsOrderById()}">
                                                    <label th:for="${foodItem.getId()} + '_portion_' + ${portion.getId()}">
                                                        <div class="checkbox-item">
                                                            <span th:if="${portion.isChecked()}">
                                                                <input type="radio" th:id="${foodItem.getId()} + '_portion_' + ${portion.getId()}" th:name="'portion_name_' + ${foodItem.getId()}" th:value="${portion.getId()}" style="margin: revert; margin-right: 10px; margin-top: 7px;" checked='checked'
                                                                       th:portion-name="${portion.getName()}" th:portion-price="${portion.getPrice()}" >
                                                            </span>
                                                            <span th:if="${!portion.isChecked()}">
                                                                <input type="radio" th:id="${foodItem.getId()} + '_portion_' + ${portion.getId()}" th:name="'portion_name_' + ${foodItem.getId()}" th:value="${portion.getId()}" style="margin: revert; margin-right: 10px; margin-top: 7px;"
                                                                       th:portion-name="${portion.getName()}" th:portion-price="${portion.getPrice()}">
                                                            </span>

                                                            <div class="checkbox-text">
                                                                <div class="checkbox-heading">
                                                                    <span class="checkbox-name">[[${portion.getName()}]]</span>
                                                                    <span class="checkbox-price">[[${portion.getPrice()}]]KM</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </th:block>
                                            </div>
                                        </form>
                                    </div>

                                    <div class="checkbox-group">
                                        <script>
                                            $(document).ready(function(){
                                                $(".check").click(function(){
                                                    $("#myCheck").prop("checked", true);
                                                });
                                                $(".uncheck").click(function(){
                                                    $("#myCheck").prop("checked", false);
                                                });
                                            });
                                        </script>
                                        <th:block th:each="condiment: ${foodItem.getCondiments()}">
                                            <label th:for="${foodItem.getId()} + '_condiment_' + ${condiment.getId()}">
                                                <div class="checkbox-item">
                                                    <input type="checkbox" th:id="${foodItem.getId()} + '_condiment_' + ${condiment.getId()}" th:name="'condiment_name_' + ${foodItem.getId()}" th:value="${condiment.getId()}" style="margin: revert; margin-right: 10px; margin-top: 6px;"
                                                           th:condiment-name="${condiment.getName()}" th:condiment-price="${condiment.getPrice()}">
                                                    <div class="checkbox-text">
                                                        <div class="checkbox-heading">
                                                            <span class="checkbox-name">[[${condiment.getName()}]]</span>
                                                            <span class="checkbox-price">[[${condiment.getPrice()}]]KM</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>

                                        </th:block>

                                    </div>
                                    <div th:if="${isClosed == true}">
                                        <a href="" class="cd-add-to-cart js-cd-add-to-cart" th:item-id="${foodItem.getId()}" th:item-image="${foodItem.getImage()}" th:item-name="${foodItem.getName()}">Dodaj</a>
                                    </div>
                                </div>
                            </div>
                        </th:block>
                    </div>
                </th:block>
            </div>
        </div>
    </section>

    <div class="cd-cart cd-cart--empty js-cd-cart">
        <a style="cursor:pointer" class="cd-cart__trigger text-replace">
            <ul class="cd-cart__count">
                <li>0</li>
                <li>0</li>
            </ul>
        </a>
        <div class="cd-cart__content">
            <div class="cd-cart__layout">
                <header class="cd-cart__header">
                    <h2 style="margin-bottom: 0;">Košarica</h2>
                </header>
                <div class="cd-cart__body">
                    <ul>

                    </ul>
                </div>
                <div class="cd-cart__footer">
                    <a id="checkout-btn" class="cd-cart__checkout" style="cursor:pointer">
                        <em>Checkout - <span>0</span>KM
                            <svg class="icon icon--sm" viewBox="0 0 24 24"><g fill="none" stroke="currentColor"><line stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="3" y1="12" x2="21" y2="12"></line><polyline stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="15,6 21,12 15,18 "></polyline></g>
                            </svg>
                        </em>
                    </a>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="fragments/general :: footer">
</footer>

<form id="checkout-form" action="/narudzba" method="post">
</form>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous">
</script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
</script>
<script type="text/javascript">
    window.addEventListener("load", function(){
        setTimeout(
            function open(event){
                document.querySelector(".overlay1").style.display = "block";
            },
            500
        )
    });


    document.querySelector("#klose").addEventListener("click", function(){
        document.querySelector(".overlay1").style.display = "none";
    });
    document.querySelector("#shop-closed-popup").addEventListener("click", function(){
        document.querySelector(".overlay1").style.display = "none";
    });
</script>
<script>
    let btnItem = document.querySelector('.menu-item');

    $(".menu-item").on('click',function(event){


        if(this.classList.contains("is-open")){

            $(this).css('backgroundColor','whitesmoke');

        }else{

            $(this).css('backgroundColor','#e7e9ed');

        }

    });

</script>
<script>
    const accordionBtns = document.querySelectorAll(".menu-item");

    accordionBtns.forEach((accordion) => {
        accordion.onclick = function () {
            this.classList.toggle("is-open");

            let content = this.nextElementSibling;
            //console.log(content);

            if (content.style.maxHeight) {
                //this is if the accordion is open
                content.style.maxHeight = null;
            } else {
                //if the accordion is currently closed
                content.style.maxHeight = content.scrollHeight + "px";
                //console.log(content.style.maxHeight);
            }
        };
    });
</script>

<script>
    // Utility function
    function Util () {};

    /*
        class manipulation functions
    */
    Util.hasClass = function(el, className) {
        if (el.classList) return el.classList.contains(className);
        else return !!el.className.match(new RegExp('(\\s|^)' + className + '(\\s|$)'));
    };

    Util.addClass = function(el, className) {
        var classList = className.split(' ');
        if (el.classList) el.classList.add(classList[0]);
        else if (!Util.hasClass(el, classList[0])) el.className += " " + classList[0];
        if (classList.length > 1) Util.addClass(el, classList.slice(1).join(' '));
    };

    Util.removeClass = function(el, className) {
        var classList = className.split(' ');
        if (el.classList) el.classList.remove(classList[0]);
        else if(Util.hasClass(el, classList[0])) {
            var reg = new RegExp('(\\s|^)' + classList[0] + '(\\s|$)');
            el.className=el.className.replace(reg, ' ');
        }
        if (classList.length > 1) Util.removeClass(el, classList.slice(1).join(' '));
    };

    Util.toggleClass = function(el, className, bool) {
        if(bool) Util.addClass(el, className);
        else Util.removeClass(el, className);
    };

    Util.setAttributes = function(el, attrs) {
        for(var key in attrs) {
            el.setAttribute(key, attrs[key]);
        }
    };

    /*
      DOM manipulation
    */
    Util.getChildrenByClassName = function(el, className) {
        var children = el.children,
            childrenByClass = [];
        for (var i = 0; i < el.children.length; i++) {
            if (Util.hasClass(el.children[i], className)) childrenByClass.push(el.children[i]);
        }
        return childrenByClass;
    };

    /*
        Animate height of an element
    */
    Util.setHeight = function(start, to, element, duration, cb) {
        var change = to - start,
            currentTime = null;

        var animateHeight = function(timestamp){
            if (!currentTime) currentTime = timestamp;
            var progress = timestamp - currentTime;
            var val = parseInt((progress/duration)*change + start);
            // console.log(val);
            element.setAttribute("style", "height:"+val+"px;");
            if(progress < duration) {
                window.requestAnimationFrame(animateHeight);
            } else {
                cb();
            }
        };

        //set the height of the element before starting animation -> fix bug on Safari
        element.setAttribute("style", "height:"+start+"px;");
        window.requestAnimationFrame(animateHeight);
    };

    /*
        Smooth Scroll
    */

    Util.scrollTo = function(final, duration, cb) {
        var start = window.scrollY || document.documentElement.scrollTop,
            currentTime = null;

        var animateScroll = function(timestamp){
            if (!currentTime) currentTime = timestamp;
            var progress = timestamp - currentTime;
            if(progress > duration) progress = duration;
            var val = Math.easeInOutQuad(progress, start, final-start, duration);
            window.scrollTo(0, val);
            if(progress < duration) {
                window.requestAnimationFrame(animateScroll);
            } else {
                cb && cb();
            }
        };

        window.requestAnimationFrame(animateScroll);
    };

    /*
      Focus utility classes
    */

    //Move focus to an element
    Util.moveFocus = function (element) {
        if( !element ) element = document.getElementsByTagName("body")[0];
        element.focus();
        if (document.activeElement !== element) {
            element.setAttribute('tabindex','-1');
            element.focus();
        }
    };

    /*
      Misc
    */

    Util.getIndexInArray = function(array, el) {
        return Array.prototype.indexOf.call(array, el);
    };

    Util.cssSupports = function(property, value) {
        if('CSS' in window) {
            return CSS.supports(property, value);
        } else {
            var jsProperty = property.replace(/-([a-z])/g, function (g) { return g[1].toUpperCase();});
            return jsProperty in document.body.style;
        }
    };

    /*
        Polyfills
    */
    //Closest() method
    if (!Element.prototype.matches) {
        Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
    }

    if (!Element.prototype.closest) {
        Element.prototype.closest = function(s) {
            var el = this;
            if (!document.documentElement.contains(el)) return null;
            do {
                if (el.matches(s)) return el;
                el = el.parentElement || el.parentNode;
            } while (el !== null && el.nodeType === 1);
            return null;
        };
    }

    //Custom Event() constructor
    if ( typeof window.CustomEvent !== "function" ) {

        function CustomEvent ( event, params ) {
            params = params || { bubbles: false, cancelable: false, detail: undefined };
            var evt = document.createEvent( 'CustomEvent' );
            evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
            return evt;
        }

        CustomEvent.prototype = window.Event.prototype;

        window.CustomEvent = CustomEvent;
    }

    /*
        Animation curves
    */
    Math.easeInOutQuad = function (t, b, c, d) {
        t /= d/2;
        if (t < 1) return c/2*t*t + b;
        t--;
        return -c/2 * (t*(t-2) - 1) + b;
    };
</script>
<script type="text/javascript">
    (function(){

        var foodItems = [];
        var cartCount = 0;
        // Add to Cart Interaction
        var cart = document.getElementsByClassName('js-cd-cart');
        if(cart.length > 0) {
            var cartAddBtns = document.getElementsByClassName('js-cd-add-to-cart'),
                cartBody = cart[0].getElementsByClassName('cd-cart__body')[0],
                cartList = cartBody.getElementsByTagName('ul')[0],
                cartTotal = cart[0].getElementsByClassName('cd-cart__checkout')[0].getElementsByTagName('span')[0],
                animatingQuantity = false;
            initCartEvents();

            //bootstrap function
            function initCartEvents() {
                // add products to cart
                for(var i = 0; i < cartAddBtns.length; i++) {(function(i){
                    cartAddBtns[i].addEventListener('click', addToCart);
                })(i);}
            };

            //add click checkout button click listner
            document.getElementById('checkout-btn').addEventListener('click', function(){

                //get form
                var form = document.getElementById("checkout-form");
                var csrf = document.querySelector('meta[name="_csrf"]').content;
                var csrf_h = document.querySelector('meta[name="_csrf_header"]').content;
                var input;

                if(foodItems.length == 1)
                    foodItems.push(null);
                //build inputs inside form to inject product ids
                for(var k=0; k<foodItems.length; k++){

                    input = document.createElement("input");
                    input.setAttribute("type", "hidden");
                    input.setAttribute("name", "foodItems");
                    input.setAttribute("value",  JSON.stringify(foodItems[k]) );
                    form.appendChild(input);
                }

                //build csrf input
                input = document.createElement("input");
                input.setAttribute("type", "hidden");
                input.setAttribute("name", "_csrf");
                input.setAttribute("value", csrf);
                form.appendChild(input);

                //submit the form
                form.submit();

            });

            //add to cart parent function
            function addToCart(event) {
                event.preventDefault();
                if(animatingQuantity) return;

                addProduct(
                    this.getAttribute('item-id'),
                    this.getAttribute('item-image'),
                    this.getAttribute('item-name')
                );
                const portionPrice = +$('input[name="portion_name_'+this.getAttribute('item-id')+'"]:checked').attr("portion-price");
                $('#btnItem_'+this.getAttribute('item-id')+' .menu-item-price').text(portionPrice.toFixed(2)+'KM');
                $("#btnItem_"+this.getAttribute('item-id')).click();
                $( '[name=condiment_name_'+this.getAttribute("item-id")+']' ).prop( "checked", false );

            };

            function blinkPrice(productId){

                $('#btnItem_'+productId+' .menu-item-price').stop().fadeOut();
                $('#btnItem_'+productId+' .menu-item-price').stop().fadeIn();
                $('#btnItem_'+productId+' .menu-item-price').css("color","#e7e9ed");
                var fadeItOut = function() {
                    $('#btnItem_'+productId+' .menu-item-price').fadeOut(100, function(){
                        fadeItIn();
                    });
                };

                var fadeItIn = function() {
                    $('#btnItem_'+productId+' .menu-item-price').fadeIn(100, fadeItOut());
                };
                //fadeItIn();

                setTimeout(()=>{
                    $('#btnItem_'+productId+' .menu-item-price').stop().fadeOut();
                    $('#btnItem_'+productId+' .menu-item-price').stop().fadeIn();
                    $('#btnItem_'+productId+' .menu-item-price').css("color","#333");
                },150);//TODO vidit constraintse za komentare
                //TODO POPRAVIT WORKING HOURS
                //TODO VIDIT ZA STATISTIKU
                //TODO OMOGUCIT RESTORANU FORMU ZA DODAVANJE NOVIH JELA I KATEGORIJA
                //TODO OMOGUCIT RESTORANU SKIDANJE JELA SA STRANICE
                //

            }

            //portions radio button on change
            $('input[type=radio]').on('change',function(){

                const productId = $(this).attr('id').split('_portion_')[0];
                const portionPrice =  +$(this).attr("portion-price");
                let condimentsPrices = 0;

                $.each($('input[name="condiment_name_'+productId+'"]:checked'), function(){

                    let condimentCheckedId = $(this).val();
                    condimentsPrices +=  +$(this).attr("condiment-price");

                });
                $('#btnItem_'+productId+' .menu-item-price').text((portionPrice+condimentsPrices).toFixed(2)+'KM');
                blinkPrice(productId);

            });

            //condiments checkbox button on change
            $('input[type=checkbox]').on('change',function(){

                const productId = $(this).attr('id').split('_condiment_')[0];
                const portionPrice = +$('input[name="portion_name_'+productId+'"]:checked').attr("portion-price");
                let condimentsPrices =  0;

                $.each($('input[name="condiment_name_'+productId+'"]:checked'), function(){

                    let condimentCheckedId = $(this).val();
                    condimentsPrices +=  +$(this).attr("condiment-price");

                });
                $('#btnItem_'+productId+' .menu-item-price').text((portionPrice+condimentsPrices).toFixed(2)+'KM');
                blinkPrice(productId);

            });

            //close cart if click outside
            $(".js-cd-cart.cd-cart").on("click",function(e){

                if($(e.target).hasClass("js-cd-cart") && $(e.target).hasClass("cd-cart--open")){

                    $(".cd-cart").removeClass("cd-cart--open");
                    $(".details-container").hide();

                }

            });

            //open/close cart
            $(".js-cd-cart .cd-cart__trigger").on("click",function(e){

                e.stopPropagation();
                if($(".cd-cart").hasClass("cd-cart--open")){

                    $(".cd-cart").removeClass("cd-cart--open");
                    $(".details-container").hide();

                }
                else $(".cd-cart").addClass("cd-cart--open");

            });

            //details button onclick
            $(".cd-cart__content").on("click",".cd-cart__details-item",function(){

                let itemId = $(this).attr("id").split("btn_detail_")[1];
                $("#order_detail_"+itemId).toggle();

            });
            //delete condiment
            $(".cd-cart__content").on("click", ".cd-cart__condiment_remove", function(){
                let condimentId = $(this).attr("id").split("condiment_delete_")[1];
                console.log("CONDIMENT CLICKED:", condimentId);
                let foodItemId = condimentId.split("__")[1];
                console.log("FOOD ITEM ID:", foodItemId);
                for (let i=0; i<foodItems.length; i++){
                    if(foodItems[i].order.uniqueId == foodItemId){
                        let condimentUniqueId = condimentId.split("__")[0];
                        var condimentLength = Object.keys(foodItems[i].order.condiments).length;
                        for(let j=0; j<condimentLength;j++){
                            if(foodItems[i].order.condiments[j].id == condimentUniqueId){
                                console.log("PROPER CONDIMENT ID:", condimentUniqueId);
                                foodItems[i].order.condiments.splice(j, 1);
                                console.log("#delete_condiment_"+condimentId);
                                $("#delete_condiment_"+condimentId).remove();

                                updateCondimentPrice(foodItems[i]);
                                updateCartTotalPrice();
                                return;
                            }
                        }//delete_condiment_
                    }
                }
                //$("#order_detail_"+condimentId).remove();
                //updateCartTotalPrice();
            });

            //delete button onclick
            $(".cd-cart__content").on("click",".cd-cart__delete-item",function(){

                let itemId = $(this).attr("id").split("btn_delete_")[1];
                $("#food_cart_"+itemId).remove();
                $("#order_detail_"+itemId).remove();
                let item = foodItems.filter(f=>{
                    return f.order.uniqueId == itemId;
                })[0];
                cartCount -= item.order.quantity;
                $(".cd-cart__count li").first().text(cartCount);
                foodItems = foodItems.filter(f=>{
                    return f.order.uniqueId != itemId;
                });
                updateCartTotalPrice();
                localStorage.setItem("_cart",JSON.stringify(foodItems));
                localStorage.setItem("_cart-count",cartCount);
                if(cartCount == 0){
                    $(".cd-cart").removeClass("cd-cart--open");
                    $(".cd-cart").addClass("cd-cart--empty");
                }

            });

            //quantity select onchange
            $(".cd-cart__content").on("change","select[id^='quantity_']",function(){

                let id = $(this).attr("id").split("quantity_")[1];
                let foodItemObjTemp = foodItems.filter(f=>{
                    return f.order.uniqueId == id;
                })[0];
                cartCount -= (+foodItemObjTemp.order.quantity);
                foodItemObjTemp.order.quantity = (+$(this).val());
                cartCount += (+$(this).val());
                $(".cd-cart__count li").first().text(cartCount);
                updateFoodPrice(foodItemObjTemp,false);
                updateCartTotalPrice();
                localStorage.setItem("_cart",JSON.stringify(foodItems));
                localStorage.setItem("_cart-count",cartCount);

            });

            //comparation method to sort condiments array
            function compareCondimetns(cond1,cond2){

                if ( cond1.id < cond2.id ){
                    return -1;
                }
                if ( cond1.id > cond2.id ){
                    return 1;
                }
                return 0;

            }

            //build parts of cart details
            function buildFoodCartParts(foodItemVar){


                let foodBox =

                    `<li id="food_cart_${foodItemVar.order.uniqueId}" class="cd-cart__product">
                        <div class="cd-cart__image">
                            <a href="#0">
                                <img src="${foodItemVar.image}" alt="placeholder">
                            </a>
                        </div>
                        <div class="cd-cart__details" style="position:relative;bottom:6px">
                            <h3 class="truncate slide-right">
                                <a style="font-size:medium;margin-bottom:5px">${foodItemVar.name} </a>
                            </h3>
                            <span class="cd-cart__price" id="item_price_${foodItemVar.order.uniqueId}" style="color:#007bff"></span>
                            <div class="cd-cart__actions" style="display:block;margin-top:4px">
                                <select id="quantity_${foodItemVar.order.uniqueId}" style="border-radius:50px;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                    </select>
                                <a style="cursor:pointer;margin-left:8px" class="cd-cart__details-item" id="btn_detail_${foodItemVar.order.uniqueId}"><i class="fa fa-plus-circle"></i> Detalji</a>
                                <a style="cursor:pointer;color:red;margin-left:5px" class="cd-cart__delete-item" id="btn_delete_${foodItemVar.order.uniqueId}"><i class="fa fa-trash"></i> Ukloni</a>
                            </div>
                        </div>
                    </li>
                    <div class="details-container" id="order_detail_${foodItemVar.order.uniqueId}" style="margin-top:10px;display:none">
                        <li class="cd-cart__product" id="order_detail_box_${foodItemVar.order.uniqueId}">
                            <div class="cd-cart__details" style="padding:0px;display:inline">`;

                if(foodItemVar.order.condiments.length > 0){

                    foodBox +=

                        `(${foodItemVar.order.portion.name})
                                        <div class="condiments-view" style="margin-top:4px">
                                            <ul style="list-style:disc !important;padding:0px;margin-left:22px">
                                                `;

                    foodItemVar.order.condiments.forEach(c=>{

                        foodBox +=

                            `
                                                    <div id="delete_condiment_${c.id}__${foodItemVar.order.uniqueId}">
                                                    <li>${c.name}
                                                        <span class="cd-cart__price" style="width: 0;"></span>
                                                        <span style="font-weight: bolder;">(${c.price} KM)</span><a style="cursor:pointer;color:red;margin-left:5px;float: right;width: 10%;" class="cd-cart__condiment_remove" id="condiment_delete_${c.id}__${foodItemVar.order.uniqueId}"><i class="fa fa-trash"></i></a>
                                                    </li>
                                                    </div>
                                                    `

                    });

                    foodBox +=

                        `
                                            </ul>
                                        </div>

                                    `;

                }else{

                    foodBox +=

                        `
                                    <ul style="list-style:disc !important;padding:0px;margin-left:20px">
                                        <li>Nema dodataka</li>
                                    </ul>
                                    `;

                }

                foodBox +=
                    `
                            </div>
                        </li>
                        <hr style="border-top: 1px solid rgba(0,0,0,.1);margin: 8px;">
                    </div>
                    `;
                cartList.insertAdjacentHTML('beforeend', foodBox);

            }

            //update cart count
            function updateCartCount(){

                cartCount++;
                localStorage.setItem("_cart-count",cartCount);
                $(".cd-cart__count li").first().text(cartCount);

            }

            //update prices
            function updateFoodPrice(f){

                let condimentsPrice = 0;

                if(f.order.condiments.length > 0){

                    f.order.condiments.forEach(c=>{

                        condimentsPrice += (+c.price);

                    });

                }

                f.order.price = (((+f.order.portion.price) + (+condimentsPrice)) * (+f.order.quantity)).toFixed(2);
                $("#food_cart_"+f.order.uniqueId+" .cd-cart__price").text((+f.order.price).toFixed(2)+" KM");

            }

            function updateCondimentPrice(foodItemObj){
                let condTotal = 0;
                let bareMealPrice = 0;
                for(let i = 0; i<foodItems.length;i++){
                    if(foodItems[i].order.uniqueId == foodItemObj.order.uniqueId){
                        foodItemObj.order.condiments.forEach(value => condTotal += value.price);
                        bareMealPrice = foodItemObj.order.portion.price;
                        foodItems[i].order.price=condTotal+bareMealPrice;
                    }
                }
                let fullMeal = condTotal + bareMealPrice;
                $("#item_price_"+foodItemObj.order.uniqueId).text(fullMeal.toFixed(2)+" KM");
                console.log("NEW MEAL PRICE:", fullMeal);
                //$("#checkout-btn em span").text(fullMeal.toFixed(2));
                //localStorage.setItem("_cart-price",fullMeal.toFixed(2));
            }

            //update global food price
            //update global food price
            function updateCartTotalPrice(){
                console.log("CART FROM updateCartTotalPrice:", foodItems);
                let cartTotalPrice = 0;

                foodItems.forEach(b=>{

                    cartTotalPrice += (+b.order.price);

                });

                $("#checkout-btn em span").text(cartTotalPrice.toFixed(2));
                localStorage.setItem("_cart-price",cartTotalPrice.toFixed(2));

            }

            //add product to cart
            function addProduct(productId,image,name) {

                let isNewItem=true;
                let uniqueIdSufix = 1;
                //initialize holders
                let condiments = [];
                let portion = { id: 0, name: "", price: 0 };
                let order = { uniqueId: "", price: 0, portion: {}, condiments: [], quantity: 1 };
                let foodItemObj = {

                    id: 0,
                    name: "",
                    image: "",
                    order: {}

                };

                //build fooditem object
                foodItemObj.id = productId;
                foodItemObj.name = name;
                foodItemObj.image = image;

                //get checked portion id
                let portionCheckedId = $('input[name="portion_name_'+productId+'"]:checked').val();
                //get checked portion input
                let portionTemp = $("#"+productId+"_portion_"+portionCheckedId);
                //build portion object
                portion.id = portionCheckedId;
                portion.name =  portionTemp.attr("portion-name");
                portion.price =  +portionTemp.attr("portion-price");
                //add portion to order
                order.portion = portion;
                //add order to fooItem
                foodItemObj.order = order;

                //loop on all checked condiments
                $.each($('input[name="condiment_name_'+productId+'"]:checked'), function(){

                    //get checked condiment id
                    let condimentCheckedId = $(this).val();
                    //initialize condiment holder
                    let condiment = { id: 0, name: "", price: 0 };
                    //build condiment object
                    condiment.id = condimentCheckedId;
                    condiment.name = $(this).attr("condiment-name");
                    condiment.price = +$(this).attr("condiment-price");

                    //push condiment to array
                    condiments.push(condiment);

                });

                //add condiments to order
                order.condiments = condiments.sort(compareCondimetns);

                let foodExists = foodItems.filter(f=>{
                    return f.id == foodItemObj.id;
                });

                if(foodExists.length > 0){

                    console.log('Food Exists');

                    let foodExists2 = foodExists.filter(f=>{
                        return f.order.portion.id == foodItemObj.order.portion.id;
                    });
                    if(foodExists2.length > 0){

                        console.log('Same portion');
                        let foodExists3 = foodExists2.filter(f=>{
                            return JSON.stringify(f.order.condiments) === JSON.stringify(foodItemObj.order.condiments);
                        });
                        if(foodExists3.length > 0){

                            isNewItem=false;
                            if(foodExists3[0].order.quantity < 9){

                                foodExists3[0].order.quantity = +foodExists3[0].order.quantity + 1;
                                $("#food_cart_"+foodExists3[0].order.uniqueId+" .cd-cart__actions #quantity_"+foodExists3[0].order.uniqueId).val(foodExists3[0].order.quantity);
                                updateFoodPrice(foodExists3[0]);
                                updateCartTotalPrice();
                                updateCartCount();
                                localStorage.setItem("_cart",JSON.stringify(foodItems));
                                console.log("Same condiments \n=> Only update quantity and price");

                            }else{

                                console.log("Quantity limit reached")

                            }

                        }else{

                            uniqueIdSufix = foodExists.length + 1;
                            console.log('Different condiments');

                        }

                    }else{

                        uniqueIdSufix = foodExists.length + 1;
                        console.log('Different portion');

                    }


                }else{

                    console.log('Food does\'nt exist');

                }
                if(isNewItem){

                    foodItemObj.order.uniqueId = foodItemObj.id+"_"+uniqueIdSufix;
                    buildFoodCartParts(foodItemObj);
                    updateFoodPrice(foodItemObj);
                    foodItems.push(foodItemObj);
                    updateCartTotalPrice();
                    updateCartCount();
                    localStorage.setItem("_cart",JSON.stringify(foodItems));
                    if( $(".cd-cart").hasClass("cd-cart--empty") )
                        $(".cd-cart").removeClass("cd-cart--empty");
                    console.log("=> New order")

                }
                console.log(foodItems);

            };

        }
    })();
</script>



</body></html>
